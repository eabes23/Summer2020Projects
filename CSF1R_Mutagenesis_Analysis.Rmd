---
title: "DNA Sequencing Analysis"
output: html_document
---

Here is a general reference on sequence analysis in R: https://www.bioconductor.org/help/course-materials/2013/useR2013/Bioconductor-tutorial.pdf

Use the analysis of epPCR data described in this paper: https://www-sciencedirect-com.proxy.library.upenn.edu/science/article/pii/S109671761830123X

Here is the link to their data files:
https://data.mendeley.com/datasets/wkd5wp9zwk/1

First, they used dada2 to preprocess their NGS sequencing reads:
https://benjjneb.github.io/dada2/tutorial.html

Then they worked up the data using a custom analysis just like we want, but they did it in Python! Here is the link to their python notebook (similar to a .Rmd):
https://data.mendeley.com/datasets/wkd5wp9zwk/1/files/5e4bed9a-f7d0-4d08-913b-58001cc9ea35

I want you to recreate their same analysis (minus a few of the downstream bits, we can discuss) but in R, so you will need to translate between these languages (I think this is actually a great way for you to learn).

For now, use their data with 300bp reads as example data, it is similar enough to what I'm hoping to gather in the next few weeks.

Experiment: Use error prone DNA polymerase to amplify parts of CSF1R gene with random mutations.
Goals of Analysis: Obtain the mutation rate, and the uniformity of the mutation rate across a string of DNA read.

Good luck!

```{r setup, include=FALSE}
#We install the data2 package from Bioconductor according to the directions on the Bioconductor website
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("dada2", version = "3.11")
install.packages("dada2")
library(dada2); packageVersion("dada2")
```

```{r}
library(tidyverse)
BiocManager::install("Biostrings")
library(Biostrings) 
```


```{r}
"/Users/ethan_23/Documents/DNA_Seq_Data/" -> path

  fnFs <- sort(list.files(path, pattern="_R1_001.fastq", full.names = TRUE))
  fnRs <- sort(list.files(path, pattern="_R2_001.fastq", full.names = TRUE))
  sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)
  plotQualityProfile(fnFs[1:2])
  plotQualityProfile(fnRs[1:2])

```

```{r}
path2 <- "/Users/ethan_23/Desktop/CSF1R_Seq"
filtFs <- file.path(path2, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs <- file.path(path2, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))
names(filtFs) <- sample.names
names(filtRs) <- sample.names

#Here we have a function that filters outlying reads and can truncate the region of the genome to exclude regions where the data has poor quality.
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(0,0),
              maxN=0, maxEE=c(Inf,Inf), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=TRUE)



#On Windows set multithread=FALSE
head(out)
```

```{r}
errF <- learnErrors(filtFs, multithread=TRUE)
errR <- learnErrors(filtRs, multithread=TRUE)

InferenceFs <- dada(filtFs, err=errF, multithread=TRUE)
InferenceRs <- dada(filtRs, err=errR, multithread=TRUE)

plotErrors(errF, nominalQ=TRUE)
plotErrors(errR, nominalQ=TRUE)

InferenceFs[[1]]
```


```{r}
  InferenceFs %>%
  map(as.data.frame) %>%
  bind_rows(.id = "Origin") %>%
  cbind(., start = 0, end = 290) -> data
  colnames(data) <- c("Origin", "Sequence", "Start", "End")
  write.csv(data, "Sequence_CSF1R_Fs.csv")
  
  InferenceRs %>%
  map(as.data.frame) %>%
  bind_rows(.id = "Origin") %>%
  cbind(., start = 0, end = 290) -> data
  colnames(data) <- c("Origin", "Sequence", "Start", "End")
  write.csv(data, "Sequence_CSF1R_Rs.csv")
  
  
```



```{r}
df300_Fs = read_csv("Sequence_CSF1R_Fs.csv")
df300_Rs = read_csv("Sequence_CSF1R_Rs.csv")

get_mut <- function(seq, ref_seq) {
  for (i in 1:str_length(ref_seq)) {
    x <- substr(ref_seq, i, i)
    y <- substr(seq, i, i)
      if (x != y) {
        ans <- paste(toString(i), ":", x, ">", y, sep = "")
        return (ans)}
  }
}

mut_finder <- function(seq, ref_seq) {
  if (str_length(seq) == str_length(ref_seq)){
    if (seq == ref_seq){
      return (ref_seq)}
    else{ 
      return (get_mut(seq, ref_seq))}
  }
}

```


```{r}
df300_Fs[1, "Sequence"] %>%
toString(first_seq) %>%
as.matrix(strsplit("")) -> refseq_split

df300_Fs[2, "Sequence"] %>%
toString(first_seq) %>%
as.matrix(strsplit("")) -> seq_split

mut_finder(seq_split, refseq_split)


```


```{r}
