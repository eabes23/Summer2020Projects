---
title: "DNA Sequencing Analysis"
output: html_document
---

Here is a general reference on sequence analysis in R: https://www.bioconductor.org/help/course-materials/2013/useR2013/Bioconductor-tutorial.pdf

Use the analysis of epPCR data described in this paper: https://www-sciencedirect-com.proxy.library.upenn.edu/science/article/pii/S109671761830123X

Here is the link to their data files:
https://data.mendeley.com/datasets/wkd5wp9zwk/1

First, they used dada2 to preprocess their NGS sequencing reads:
https://benjjneb.github.io/dada2/tutorial.html

Then they worked up the data using a custom analysis just like we want, but they did it in Python! Here is the link to their python notebook (similar to a .Rmd):
https://data.mendeley.com/datasets/wkd5wp9zwk/1/files/5e4bed9a-f7d0-4d08-913b-58001cc9ea35

I want you to recreate their same analysis (minus a few of the downstream bits, we can discuss) but in R, so you will need to translate between these languages (I think this is actually a great way for you to learn).

For now, use their data with 300bp reads as example data, it is similar enough to what I'm hoping to gather in the next few weeks.

Experiment: Use error prone DNA polymerase to amplify parts of CSF1R gene with random mutations.
Goals of Analysis: Obtain the mutation rate, and the uniformity of the mutation rate across a string of DNA read.

```{r setup, include=FALSE}
library(dada2); packageVersion("dada2")
library(tidyverse)
library(Biostrings) 
#don't include the install code in a notebook, instead just run it once in the console
```

```{r}
#"/Users/ethan_23/Documents/DNA_Seq_Data/" -> path #I use left to right flow only for the output of pipes
path <- "/Users/grahampeet/Desktop/Bennett\ Lab/Bennett-Projects/epPCR_example_data/"

fnFs <- sort(list.files(path, pattern = "_R1_001.fastq", full.names = TRUE))
fnRs <- sort(list.files(path, pattern = "_R2_001.fastq", full.names = TRUE))
  sample.names <- sapply(
    strsplit(
      basename(fnFs), "_"), `[`, 1)

plotQualityProfile(fnFs[1:2])
plotQualityProfile(fnRs[1:2])
```

```{r}
path2 <- "/Users/grahampeet/Desktop/CSF1R_Seq"

filtFs <- file.path(path2, "filtered", paste0(sample.names, "_F_filt.fastq.gz")) 
filtRs <- file.path(path2, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))

names(filtFs) <- sample.names
names(filtRs) <- sample.names

#Here we have a function that filters outlying reads and can truncate the region of the genome to exclude regions where the data has poor quality.
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, 
                     #truncLen = c(0, 0),
                     #maxN = 0, default
                     #maxEE = c(Inf, Inf), 
                     #truncQ = 2, 
                     #rm.phix = T,
                     #compress = T, remove all defults
                     multithread = T)
head(out) 

#something to consider doing in cases like this is to find a way to create a small but representative sample of the data so you can write/debug without waiting for your code to run
```

```{r}
errF <- learnErrors(filtFs, multithread = T)
errR <- learnErrors(filtRs, multithread = T)

InferenceFs <- dada(filtFs, err = errF, multithread = T)
InferenceRs <- dada(filtRs, err = errR, multithread = T)

plotErrors(errF, nominalQ = T)
plotErrors(errR, nominalQ = T)

InferenceFs[[1]]

#You know what I'm gonna say...try to turn this whole first portion into a piped operation. You may need 2 pipes or something. That's fine of course. You can use purrr::walk to print your plots without breaking the pipe

#I think you will want to merge the paired reads before moving forward
```


```{r}
InferenceFs %>%
  map(as.data.frame) %>%
  bind_rows(.id = "Origin") %>%
  cbind(., start = 0, end = 290) -> data
  
colnames(data) <- c("Origin", "Sequence", "Start", "End")
write.csv(data, "Sequence_CSF1R_Fs.csv")
  
InferenceRs %>%
  map(as.data.frame) %>%
  bind_rows(.id = "Origin") %>%
  cbind(., start = 0, end = 290) -> data
  
colnames(data) <- c("Origin", "Sequence", "Start", "End")
write.csv(data, "Sequence_CSF1R_Rs.csv")
  
#Great! Now bind these into a list and make it just one pipe
```



```{r}
df300_Fs = read_csv("Sequence_CSF1R_Fs.csv")
df300_Rs = read_csv("Sequence_CSF1R_Rs.csv")

get_mut <- function(seq, ref_seq) {
  for (i in 1:str_length(ref_seq)) {
    x <- substr(ref_seq, i, i)
    y <- substr(seq, i, i)
      if (x != y) {
        ans <- paste(toString(i), ":", x, ">", y, sep = "")
        return(ans)}
  }
}

mut_finder <- function(seq, ref_seq) {
  if (str_length(seq) == str_length(ref_seq)) {
    if (seq == ref_seq) {
      return(ref_seq)}
    else { 
      return(get_mut(seq, ref_seq))}
  }
}

```


```{r}
df300_Fs[1, "Sequence"] %>%
  toString(first_seq) %>%
  as.matrix(strsplit("")) -> refseq_split

df300_Fs[2, "Sequence"] %>%
  toString(first_seq) %>%
  as.matrix(strsplit("")) -> seq_split

mut_finder(seq_split, refseq_split)
```

